{% extends "base.html" %}

{% block title %}Dashboard - Budget Planner{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="dashboard-header">
            <h1><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
            <p class="text-white">Welcome back, {{ user.username }}! Here's your financial overview.</p>
        </div>
    </div>
</div>

{% if latest_entry %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card income-card">
            <div class="card-body">
                <div class="stats-icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="stats-content">
                    <h5>Total Income</h5>
                    <h3>₹{{ "%.2f"|format(latest_entry.salary + latest_entry.freelancing_one + latest_entry.freelancing_two) }}</h3>
                    <small class="text-muted">{{ latest_entry.month }} {{ latest_entry.year }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card expense-card">
            <div class="card-body">
                <div class="stats-icon">
                    <i class="fas fa-minus-circle"></i>
                </div>
                <div class="stats-content">
                    <h5>Total Expenses</h5>
                    <h3>₹{{ "%.2f"|format(latest_entry.mobile_recharge + latest_entry.wifi + latest_entry.emi_one + latest_entry.emi_two + latest_entry.emi_three + latest_entry.emi_four + latest_entry.food + latest_entry.rent + latest_entry.creditcard_one + latest_entry.creditcard_two + latest_entry.shopping + latest_entry.travel + latest_entry.other_expenses) }}</h3>
                    <small class="text-muted">{{ latest_entry.month }} {{ latest_entry.year }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card savings-card">
            <div class="card-body">
                <div class="stats-icon">
                    <i class="fas fa-piggy-bank"></i>
                </div>
                <div class="stats-content">
                    <h5>Net Savings</h5>
                    {% set total_income = latest_entry.salary + latest_entry.freelancing_one + latest_entry.freelancing_two %}
                    {% set total_expenses = latest_entry.mobile_recharge + latest_entry.wifi + latest_entry.emi_one + latest_entry.emi_two + latest_entry.emi_three + latest_entry.emi_four + latest_entry.food + latest_entry.rent + latest_entry.creditcard_one + latest_entry.creditcard_two + latest_entry.shopping + latest_entry.travel + latest_entry.other_expenses %}
                    <h3>₹{{ "%.2f"|format(total_income - total_expenses) }}</h3>
                    <small class="text-muted">{{ latest_entry.month }} {{ latest_entry.year }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stats-card salary-card">
            <div class="card-body">
                <div class="stats-icon">
                    <i class="fas fa-briefcase"></i>
                </div>
                <div class="stats-content">
                    <h5>Salary</h5>
                    <h3>₹{{ "%.2f"|format(latest_entry.salary) }}</h3>
                    <small class="text-muted">Fixed Income</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bucket List Stats -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card stats-card bucket-card">
            <div class="card-body">
                <div class="stats-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stats-content">
                    <h5>Bucket List Goals</h5>
                    <h3>{{ total_bucket_items }} Items</h3>
                    <small class="text-muted">{{ completed_bucket_items }} Completed • {{ total_bucket_items - completed_bucket_items }} Pending</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card stats-card progress-card">
            <div class="card-body">
                <div class="stats-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="stats-content">
                    <h5>Achievement Rate</h5>
                    {% if total_bucket_items > 0 %}
                    {% set completion_rate = (completed_bucket_items / total_bucket_items * 100)|round(1) %}
                    <h3>{{ completion_rate }}%</h3>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ completion_rate }}%"></div>
                    </div>
                    {% else %}
                    <h3>0%</h3>
                    <small class="text-muted">No goals set yet</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Chart Controls -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Financial Charts</h5>
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <a href="/yearly-charts" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-calendar-alt me-1"></i>Yearly Analysis
                        </a>
                        <a href="/monthly-analysis" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-calendar-day me-1"></i>Monthly Analysis
                        </a>
                        <div class="d-flex align-items-center">
                            <label for="timespanSelect" class="form-label me-2 mb-0">Time Period:</label>
                            <select class="form-select form-select-sm" id="timespanSelect" onchange="updateCharts()">
                                <option value="all">All Time</option>
                                <option value="current_month">Current Month</option>
                                <option value="quarter">Current Quarter</option>
                                <option value="half_year">Current Half Year</option>
                                <option value="current_year">Current Year</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if all_entries %}
<div class="row">
    <div class="col-md-6">
        <div class="card chart-card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar me-2"></i>Income vs Expenses</h5>
            </div>
            <div class="card-body">
                <canvas id="incomeExpenseChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card chart-card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie me-2"></i>Expense Breakdown</h5>
            </div>
            <div class="card-body">
                <canvas id="expenseBreakdownChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card chart-card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line me-2"></i>Income Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="incomeTrendChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card chart-card">
            <div class="card-header">
                <h5><i class="fas fa-chart-area me-2"></i>Savings Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="savingsTrendChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card chart-card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar me-2"></i>Monthly Comparison</h5>
            </div>
            <div class="card-body">
                <canvas id="monthlyComparisonChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Charts Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card chart-card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-credit-card me-2"></i>EMI Breakdown</h5>
            </div>
            <div class="card-body">
                <canvas id="emiBreakdownChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card chart-card">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-credit-card me-2"></i>Credit Card Analysis</h5>
            </div>
            <div class="card-body">
                <canvas id="creditCardChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card chart-card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-utensils me-2"></i>Food Expenses Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="foodTrendChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card chart-card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-home me-2"></i>Fixed vs Variable Expenses</h5>
            </div>
            <div class="card-body">
                <canvas id="fixedVariableChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card chart-card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-chart-line me-2"></i>Expense Category Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryTrendsChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if not all_entries %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
                <h4>No Data Available</h4>
                <p class="text-muted">Start by adding your budget entries to see beautiful charts and insights.</p>
                <div class="d-flex justify-content-center gap-3">
                    <a href="/budget" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Budget Entry
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
let chartInstances = {};

async function loadChartData(timespan = 'all') {
    try {
        console.log('Fetching chart data from:', `/api/chart-data?timespan=${timespan}`);
        const response = await fetch(`/api/chart-data?timespan=${timespan}`);
        
        if (!response.ok) {
            console.error('Failed to fetch chart data:', response.status, response.statusText);
            return null;
        }
        
        const data = await response.json();
        console.log('Received chart data:', data);
        return data;
    } catch (error) {
        console.error('Error loading chart data:', error);
        return null;
    }
}

function destroyExistingCharts() {
    Object.values(chartInstances).forEach(chart => {
        if (chart) chart.destroy();
    });
    chartInstances = {};
}

async function updateCharts() {
    const timespanSelect = document.getElementById('timespanSelect');
    if (!timespanSelect) {
        console.error('Timespan select element not found');
        return;
    }
    
    const timespan = timespanSelect.value;
    console.log('Loading chart data for timespan:', timespan);
    
    const data = await loadChartData(timespan);
    
    if (!data) {
        console.error('No chart data received');
        return;
    }
    
    console.log('Chart data loaded:', data);

    destroyExistingCharts();
    initializeCharts(data);
}

function initializeCharts(data) {
    if (!data || data.months.length === 0) {
        console.warn('No data available for charts');
        
        // Show a message on each canvas that data is not available
        const canvasIds = [
            'incomeExpenseChart', 'expenseBreakdownChart', 'incomeTrendChart',
            'savingsTrendChart', 'monthlyComparisonChart', 'emiBreakdownChart',
            'creditCardChart', 'foodTrendChart', 'fixedVariableChart', 'categoryTrendsChart'
        ];
        
        canvasIds.forEach(id => {
            const canvas = document.getElementById(id);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No data available', canvas.width / 2, canvas.height / 2);
            }
        });
        return;
    }
    
    console.log('Initializing charts with data:', data);
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library is not loaded');
        return;
    }
    
    try {
        initializeChart1(data);
        initializeChart2(data);
        initializeChart3(data);
        initializeChart4(data);
        initializeChart5(data);
        initializeChart6(data);
        initializeChart7(data);
        initializeChart8(data);
        initializeChart9(data);
        initializeChart10(data);
    } catch (error) {
        console.error('Error initializing charts:', error);
    }
}

function initializeChart1(data) {
    // Income vs Expenses Chart
    const ctx1 = document.getElementById('incomeExpenseChart');
    if (!ctx1) {
        console.error('incomeExpenseChart canvas not found');
        return;
    }
    
    console.log('Creating incomeExpenseChart');
    try {
        chartInstances.incomeExpense = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: data.months,
            datasets: [
                {
                    label: 'Income',
                    data: data.income.total,
                    backgroundColor: 'rgba(40, 167, 69, 0.8)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Expenses',
                    data: data.expenses.total,
                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₹' + value;
                        }
                    }
                }
            }
        }
    });
    } catch (error) {
        console.error('Error creating incomeExpenseChart:', error);
    }
}

function initializeChart2(data) {
    // Expense Breakdown Pie Chart
    const latestIndex = data.months.length - 1;
    const ctx2 = document.getElementById('expenseBreakdownChart');
    if (!ctx2) {
        console.error('expenseBreakdownChart canvas not found');
        return;
    }
    
    console.log('Creating expenseBreakdownChart');
    try {
        chartInstances.expenseBreakdown = new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: ['Mobile', 'WiFi', 'EMI 1', 'EMI 2', 'EMI 3', 'EMI 4', 'Food', 'Rent', 'Credit Card 1', 'Credit Card 2', 'Shopping', 'Travel', 'Other'],
            datasets: [{
                data: [
                    data.expenses.mobile_recharge[latestIndex] || 0,
                    data.expenses.wifi[latestIndex] || 0,
                    data.expenses.emi_one[latestIndex] || 0,
                    data.expenses.emi_two[latestIndex] || 0,
                    data.expenses.emi_three[latestIndex] || 0,
                    data.expenses.emi_four[latestIndex] || 0,
                    data.expenses.food[latestIndex] || 0,
                    data.expenses.rent[latestIndex] || 0,
                    data.expenses.creditcard_one[latestIndex] || 0,
                    data.expenses.creditcard_two[latestIndex] || 0,
                    data.expenses.shopping[latestIndex] || 0,
                    data.expenses.travel[latestIndex] || 0,
                    data.expenses.other_expenses[latestIndex] || 0
                ],
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                    '#4BC0C0', '#36A2EB', '#FFCE56', '#9966FF', '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true
        }
    });
    } catch (error) {
        console.error('Error creating expenseBreakdownChart:', error);
    }
}

function initializeChart3(data) {
    // Income Trend Line Chart
    const ctx3 = document.getElementById('incomeTrendChart');
    if (!ctx3) {
        console.error('incomeTrendChart canvas not found');
        return;
    }
    
    console.log('Creating incomeTrendChart');
    try {
        chartInstances.incomeTrend = new Chart(ctx3, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [
                    {
                        label: 'Salary',
                        data: data.income.salary,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: true
                    },
                    {
                        label: 'Freelancing 1',
                        data: data.income.freelancing_one,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        fill: true
                    },
                    {
                        label: 'Freelancing 2',
                        data: data.income.freelancing_two,
                        borderColor: 'rgba(255, 206, 86, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating incomeTrendChart:', error);
    }
}

function initializeChart4(data) {
    // Savings Trend Chart
    const savingsData = data.income.total.map((income, index) => income - data.expenses.total[index]);
    const ctx4 = document.getElementById('savingsTrendChart');
    if (!ctx4) {
        console.error('savingsTrendChart canvas not found');
        return;
    }
    
    console.log('Creating savingsTrendChart');
    try {
        chartInstances.savingsTrend = new Chart(ctx4, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [{
                    label: 'Net Savings',
                    data: savingsData,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating savingsTrendChart:', error);
    }
}

function initializeChart5(data) {
    // Monthly Comparison Chart
    const ctx5 = document.getElementById('monthlyComparisonChart');
    if (!ctx5) {
        console.error('monthlyComparisonChart canvas not found');
        return;
    }
    
    console.log('Creating monthlyComparisonChart');
    try {
        chartInstances.monthlyComparison = new Chart(ctx5, {
            type: 'bar',
            data: {
                labels: data.months,
                datasets: [
                    {
                        label: 'Salary',
                        data: data.income.salary,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)'
                    },
                    {
                        label: 'Freelancing',
                        data: data.income.freelancing_one.map((val, idx) => val + data.income.freelancing_two[idx]),
                        backgroundColor: 'rgba(255, 99, 132, 0.8)'
                    },
                    {
                        label: 'Total Expenses',
                        data: data.expenses.total,
                        backgroundColor: 'rgba(255, 206, 86, 0.8)'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: false
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating monthlyComparisonChart:', error);
    }
}

function initializeChart6(data) {
    // EMI Breakdown Chart
    const latestIndex = data.months.length - 1;
    const ctx6 = document.getElementById('emiBreakdownChart');
    if (!ctx6) {
        console.error('emiBreakdownChart canvas not found');
        return;
    }
    
    console.log('Creating emiBreakdownChart');
    try {
        chartInstances.emiBreakdown = new Chart(ctx6, {
            type: 'doughnut',
            data: {
                labels: ['EMI 1', 'EMI 2', 'EMI 3', 'EMI 4'],
                datasets: [{
                    data: [
                        data.expenses.emi_one[latestIndex] || 0,
                        data.expenses.emi_two[latestIndex] || 0,
                        data.expenses.emi_three[latestIndex] || 0,
                        data.expenses.emi_four[latestIndex] || 0
                    ],
                    backgroundColor: [
                        '#FF6B6B',
                        '#4ECDC4',
                        '#45B7D1',
                        '#96CEB4'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ₹' + context.parsed;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating emiBreakdownChart:', error);
    }
}

function initializeChart7(data) {
    // Credit Card Analysis Chart
    const ctx7 = document.getElementById('creditCardChart');
    if (!ctx7) {
        console.error('creditCardChart canvas not found');
        return;
    }
    
    console.log('Creating creditCardChart');
    try {
        chartInstances.creditCard = new Chart(ctx7, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [
                    {
                        label: 'Credit Card 1',
                        data: data.expenses.creditcard_one,
                        borderColor: '#FF6B6B',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#FF6B6B',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    },
                    {
                        label: 'Credit Card 2',
                        data: data.expenses.creditcard_two,
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#4ECDC4',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating creditCardChart:', error);
    }
}

function initializeChart8(data) {
    // Food Expenses Trend Chart
    const ctx8 = document.getElementById('foodTrendChart');
    if (!ctx8) {
        console.error('foodTrendChart canvas not found');
        return;
    }
    
    console.log('Creating foodTrendChart');
    try {
        chartInstances.foodTrend = new Chart(ctx8, {
            type: 'bar',
            data: {
                labels: data.months,
                datasets: [{
                    label: 'Food Expenses',
                    data: data.expenses.food,
                    backgroundColor: function(context) {
                        const chart = context.chart;
                        const {ctx, chartArea} = chart;
                        if (!chartArea) return null;
                        
                        const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                        gradient.addColorStop(0, 'rgba(76, 175, 80, 0.2)');
                        gradient.addColorStop(1, 'rgba(76, 175, 80, 0.8)');
                        return gradient;
                    },
                    borderColor: '#4CAF50',
                    borderWidth: 2,
                    borderRadius: 4,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating foodTrendChart:', error);
    }
}

function initializeChart9(data) {
    // Fixed vs Variable Expenses Chart
    const ctx9 = document.getElementById('fixedVariableChart');
    if (!ctx9) {
        console.error('fixedVariableChart canvas not found');
        return;
    }
    
    console.log('Creating fixedVariableChart');
    try {
        const fixedExpenses = data.months.map((_, index) => 
            (data.expenses.rent[index] || 0) + 
            (data.expenses.emi_one[index] || 0) + 
            (data.expenses.emi_two[index] || 0) + 
            (data.expenses.emi_three[index] || 0) + 
            (data.expenses.emi_four[index] || 0) +
            (data.expenses.wifi[index] || 0)
        );
        const variableExpenses = data.months.map((_, index) => 
            (data.expenses.food[index] || 0) + 
            (data.expenses.shopping[index] || 0) + 
            (data.expenses.travel[index] || 0) + 
            (data.expenses.creditcard_one[index] || 0) + 
            (data.expenses.creditcard_two[index] || 0) + 
            (data.expenses.mobile_recharge[index] || 0) +
            (data.expenses.other_expenses[index] || 0)
        );
        
        chartInstances.fixedVariable = new Chart(ctx9, {
            type: 'bar',
            data: {
                labels: data.months,
                datasets: [
                    {
                        label: 'Fixed Expenses',
                        data: fixedExpenses,
                        backgroundColor: '#FF7043',
                        borderColor: '#FF5722',
                        borderWidth: 1
                    },
                    {
                        label: 'Variable Expenses',
                        data: variableExpenses,
                        backgroundColor: '#42A5F5',
                        borderColor: '#2196F3',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating fixedVariableChart:', error);
    }
}

function initializeChart10(data) {
    // Category Trends Chart
    const ctx10 = document.getElementById('categoryTrendsChart');
    if (!ctx10) {
        console.error('categoryTrendsChart canvas not found');
        return;
    }
    
    console.log('Creating categoryTrendsChart');
    try {
        chartInstances.categoryTrends = new Chart(ctx10, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [
                    {
                        label: 'Food',
                        data: data.expenses.food,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Shopping',
                        data: data.expenses.shopping,
                        borderColor: '#E91E63',
                        backgroundColor: 'rgba(233, 30, 99, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Travel',
                        data: data.expenses.travel,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Credit Cards',
                        data: data.months.map((_, index) => 
                            (data.expenses.creditcard_one[index] || 0) + 
                            (data.expenses.creditcard_two[index] || 0)
                        ),
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating categoryTrendsChart:', error);
    }
}

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - checking for Chart.js');
    
    // Wait a bit for Chart.js to load
    setTimeout(() => {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not available');
            return;
        }
        console.log('Chart.js is available, initializing charts');
        updateCharts();
    }, 100);
});
</script>
{% endblock %}
