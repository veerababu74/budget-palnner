{% extends "base.html" %}

{% block title %}Budget Entry - Budget Planner{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="budget-header">
            <h1><i class="fas fa-table me-2"></i>Budget Entry</h1>
            <p class="text-muted">Enter your monthly income and expenses here.</p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus-circle me-2"></i>Add/Update Budget Entry</h5>
            </div>
            <div class="card-body">
                <div class="current-month-info">
                    <div class="alert alert-info">
                        <i class="fas fa-calendar me-2"></i>
                        <strong>Current Month:</strong> <span id="currentMonth"></span>
                        <small class="ms-2">Budget data will be saved for this month automatically</small>
                    </div>
                </div>
                
                <!-- Warning Alert for Existing Entry -->
                {% if show_warning %}
                <div class="alert alert-warning" style="background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; border: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
                        <div class="flex-grow-1">
                            <h6 class="mb-1" style="color: white;"><strong>Budget Already Exists for This Month!</strong></h6>
                            <p class="mb-2" style="color: white;">A budget entry for {{ existing_entry.month }} {{ existing_entry.year }} already exists. Do you want to overwrite it?</p>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-light btn-sm" onclick="confirmOverwrite()">
                                    <i class="fas fa-check me-1"></i>Yes, Overwrite
                                </button>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="cancelOverwrite()">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                                <a href="/budget/edit/{{ existing_entry.id }}" class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-edit me-1"></i>Edit Existing Entry
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <form method="POST" action="/budget" class="budget-form" id="budgetForm">
                    
                    <div class="section-header">
                        <h6><i class="fas fa-plus-circle text-success me-2"></i>Income Sources</h6>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="salary" class="form-label">Salary (Fixed)</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="salary" name="salary" 
                                       step="0.01" min="0" value="{{ form_data.salary if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="freelancing_one" class="form-label">Freelancing 1</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="freelancing_one" name="freelancing_one" 
                                       step="0.01" min="0" value="{{ form_data.freelancing_one if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="freelancing_two" class="form-label">Freelancing 2</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="freelancing_two" name="freelancing_two" 
                                       step="0.01" min="0" value="{{ form_data.freelancing_two if form_data else 0 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-header">
                        <h6><i class="fas fa-minus-circle text-danger me-2"></i>Monthly Expenses</h6>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="mobile_recharge" class="form-label">Mobile Recharge</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="mobile_recharge" name="mobile_recharge" 
                                       step="0.01" min="0" value="{{ form_data.mobile_recharge if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="wifi" class="form-label">WiFi/Internet</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="wifi" name="wifi" 
                                       step="0.01" min="0" value="{{ form_data.wifi if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="food" class="form-label">Food</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="food" name="food" 
                                       step="0.01" min="0" value="{{ form_data.food if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="rent" class="form-label">Rent</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="rent" name="rent" 
                                       step="0.01" min="0" value="{{ form_data.rent if form_data else 0 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-header">
                        <h6><i class="fas fa-credit-card text-warning me-2"></i>EMIs</h6>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="emi_one" class="form-label">EMI 1</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="emi_one" name="emi_one" 
                                       step="0.01" min="0" value="{{ form_data.emi_one if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="emi_two" class="form-label">EMI 2</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="emi_two" name="emi_two" 
                                       step="0.01" min="0" value="{{ form_data.emi_two if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="emi_three" class="form-label">EMI 3</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="emi_three" name="emi_three" 
                                       step="0.01" min="0" value="{{ form_data.emi_three if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="emi_four" class="form-label">EMI 4</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="emi_four" name="emi_four" 
                                       step="0.01" min="0" value="{{ form_data.emi_four if form_data else 0 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-header">
                        <h6><i class="fas fa-shopping-cart text-info me-2"></i>Additional Expenses</h6>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="creditcard_one" class="form-label">Credit Card 1</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="creditcard_one" name="creditcard_one" 
                                       step="0.01" min="0" value="{{ form_data.creditcard_one if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="creditcard_two" class="form-label">Credit Card 2</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="creditcard_two" name="creditcard_two" 
                                       step="0.01" min="0" value="{{ form_data.creditcard_two if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="shopping" class="form-label">Shopping</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="shopping" name="shopping" 
                                       step="0.01" min="0" value="{{ form_data.shopping if form_data else 0 }}">
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="travel" class="form-label">Travel</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="travel" name="travel" 
                                       step="0.01" min="0" value="{{ form_data.travel if form_data else 0 }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="other_expenses" class="form-label">Other Expenses</label>
                            <div class="input-group">
                                <span class="input-group-text">â‚¹</span>
                                <input type="number" class="form-control" id="other_expenses" name="other_expenses" 
                                       step="0.01" min="0" value="{{ form_data.other_expenses if form_data else 0 }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Variable Budget Info -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-lightbulb me-3" style="font-size: 1.2rem;"></i>
                            <div>
                                <strong>ðŸ’¡ New Feature: Variable Budget Tracker</strong>
                                <p class="mb-1 small">
                                    For expenses that change throughout the month (like food, travel, shopping), 
                                    use our <a href="/variable-budget" class="alert-link">Variable Budget Tracker</a> 
                                    to add and update them as you go, then finalize at month-end.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-section">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="summary-card income-summary">
                                    <h6>Total Income</h6>
                                    <span id="totalIncome">â‚¹0.00</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-card expense-summary">
                                    <h6>Total Expenses</h6>
                                    <span id="totalExpenses">â‚¹0.00</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-card savings-summary">
                                    <h6>Net Savings</h6>
                                    <span id="netSavings">â‚¹0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <!-- Hidden input for confirmation -->
                        <input type="hidden" name="confirm_overwrite" id="confirm_overwrite" value="">
                        
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="fas fa-save me-2"></i>Save Budget Entry
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history me-2"></i>Recent Entries</h5>
            </div>
            <div class="card-body">
                {% if entries %}
                    <div class="recent-entries">
                        {% for entry in entries[:5] %}
                        <div class="entry-item">
                            <div class="entry-header">
                                <strong>{{ entry.month }} {{ entry.year }}</strong>
                                <small class="text-muted">{{ entry.created_at.strftime('%Y-%m-%d') }}</small>
                            </div>
                            <div class="entry-details">
                                {% set total_income = entry.salary + entry.freelancing_one + entry.freelancing_two %}
                                {% set total_expenses = entry.mobile_recharge + entry.wifi + entry.emi_one + entry.emi_two + entry.emi_three + entry.emi_four + entry.food + entry.rent + entry.creditcard_one + entry.creditcard_two + entry.shopping + entry.travel + entry.other_expenses %}
                                <small>Income: <span class="text-success">â‚¹{{ "%.2f"|format(total_income) }}</span></small><br>
                                <small>Expenses: <span class="text-danger">â‚¹{{ "%.2f"|format(total_expenses) }}</span></small><br>
                                <small>Savings: <span class="{% if total_income - total_expenses >= 0 %}text-success{% else %}text-danger{% endif %}">â‚¹{{ "%.2f"|format(total_income - total_expenses) }}</span></small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No entries yet. Start by adding your first budget entry!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if entries %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-table me-2"></i>All Budget Entries</h5>
                <div class="d-flex align-items-center">
                    <input type="text" id="searchTable" class="form-control form-control-sm me-2" placeholder="Search..." style="width: 200px;">
                    <select id="yearFilter" class="form-select form-select-sm me-2" style="width: 120px;">
                        <option value="">All Years</option>
                    </select>
                    <select id="monthFilter" class="form-select form-select-sm" style="width: 120px;">
                        <option value="">All Months</option>
                        <option value="January">January</option>
                        <option value="February">February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="budgetTable">
                        <thead>
                            <tr>
                                <th>Month/Year</th>
                                <th>Salary</th>
                                <th>Freelancing</th>
                                <th>Total Income</th>
                                <th>Total Expenses</th>
                                <th>Net Savings</th>
                                <th>Date Added</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="budgetTableBody">
                            {% for entry in entries %}
                            <tr data-month="{{ entry.month }}" data-year="{{ entry.year }}">
                                <td><strong>{{ entry.month }} {{ entry.year }}</strong></td>
                                <td>â‚¹{{ "%.2f"|format(entry.salary) }}</td>
                                <td>â‚¹{{ "%.2f"|format(entry.freelancing_one + entry.freelancing_two) }}</td>
                                {% set total_income = entry.salary + entry.freelancing_one + entry.freelancing_two %}
                                <td class="text-success"><strong>â‚¹{{ "%.2f"|format(total_income) }}</strong></td>
                                {% set total_expenses = entry.mobile_recharge + entry.wifi + entry.emi_one + entry.emi_two + entry.emi_three + entry.emi_four + entry.food + entry.rent + entry.creditcard_one + entry.creditcard_two + entry.shopping + entry.travel + entry.other_expenses %}
                                <td class="text-danger"><strong>â‚¹{{ "%.2f"|format(total_expenses) }}</strong></td>
                                {% set net_savings = total_income - total_expenses %}
                                <td class="{% if net_savings >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    <strong>â‚¹{{ "%.2f"|format(net_savings) }}</strong>
                                </td>
                                <td>{{ entry.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <a href="/budget/edit/{{ entry.id }}" class="btn btn-sm btn-warning me-1">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <form method="POST" action="/budget/delete/{{ entry.id }}" style="display: inline-block;" onsubmit="return confirm('Are you sure you want to delete this entry?')">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted">
                        Showing <span id="startEntry">1</span> to <span id="endEntry">10</span> of <span id="totalEntries">{{ entries|length }}</span> entries
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Real-time calculation
document.addEventListener('DOMContentLoaded', function() {
    const incomeInputs = ['salary', 'freelancing_one', 'freelancing_two'];
    const expenseInputs = ['mobile_recharge', 'wifi', 'emi_one', 'emi_two', 'emi_three', 'emi_four', 'food', 'rent', 'creditcard_one', 'creditcard_two', 'shopping', 'travel', 'other_expenses'];
    
    // Display current month
    const now = new Date();
    const currentMonth = now.toLocaleString('default', { month: 'long', year: 'numeric' });
    document.getElementById('currentMonth').textContent = currentMonth;
    
    function calculateTotals() {
        let totalIncome = 0;
        let totalExpenses = 0;
        
        incomeInputs.forEach(id => {
            const value = parseFloat(document.getElementById(id).value) || 0;
            totalIncome += value;
        });
        
        expenseInputs.forEach(id => {
            const value = parseFloat(document.getElementById(id).value) || 0;
            totalExpenses += value;
        });
        
        const netSavings = totalIncome - totalExpenses;
        
        document.getElementById('totalIncome').textContent = 'â‚¹' + totalIncome.toFixed(2);
        document.getElementById('totalExpenses').textContent = 'â‚¹' + totalExpenses.toFixed(2);
        document.getElementById('netSavings').textContent = 'â‚¹' + netSavings.toFixed(2);
        
        // Update colors
        const savingsElement = document.getElementById('netSavings');
        savingsElement.className = netSavings >= 0 ? 'text-success' : 'text-danger';
    }
    
    // Add event listeners to all input fields
    [...incomeInputs, ...expenseInputs].forEach(id => {
        document.getElementById(id).addEventListener('input', calculateTotals);
    });
    
    // Initial calculation
    calculateTotals();
    
    // Table pagination and search functionality
    const rowsPerPage = 10;
    let currentPage = 1;
    let filteredRows = [];
    
    function initializeTable() {
        const table = document.getElementById('budgetTable');
        if (!table) return;
        
        const tbody = document.getElementById('budgetTableBody');
        const allRows = Array.from(tbody.getElementsByTagName('tr'));
        
        // Populate year filter
        const yearFilter = document.getElementById('yearFilter');
        const years = [...new Set(allRows.map(row => row.dataset.year))].sort();
        years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearFilter.appendChild(option);
        });
        
        filteredRows = allRows;
        displayPage(1);
        updatePagination();
        
        // Search functionality
        document.getElementById('searchTable').addEventListener('input', filterTable);
        document.getElementById('monthFilter').addEventListener('change', filterTable);
        document.getElementById('yearFilter').addEventListener('change', filterTable);
    }
    
    function filterTable() {
        const search = document.getElementById('searchTable').value.toLowerCase();
        const monthFilter = document.getElementById('monthFilter').value;
        const yearFilter = document.getElementById('yearFilter').value;
        const tbody = document.getElementById('budgetTableBody');
        const allRows = Array.from(tbody.getElementsByTagName('tr'));
        
        filteredRows = allRows.filter(row => {
            const text = row.textContent.toLowerCase();
            const month = row.dataset.month;
            const year = row.dataset.year;
            
            const matchesSearch = search === '' || text.includes(search);
            const matchesMonth = monthFilter === '' || month === monthFilter;
            const matchesYear = yearFilter === '' || year === yearFilter;
            
            return matchesSearch && matchesMonth && matchesYear;
        });
        
        currentPage = 1;
        displayPage(1);
        updatePagination();
    }
    
    function displayPage(page) {
        const tbody = document.getElementById('budgetTableBody');
        const allRows = Array.from(tbody.getElementsByTagName('tr'));
        
        // Hide all rows
        allRows.forEach(row => row.style.display = 'none');
        
        // Show rows for current page
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageRows = filteredRows.slice(start, end);
        
        pageRows.forEach(row => row.style.display = '');
        
        // Update info
        const totalEntries = filteredRows.length;
        const startEntry = totalEntries > 0 ? start + 1 : 0;
        const endEntry = Math.min(end, totalEntries);
        
        document.getElementById('startEntry').textContent = startEntry;
        document.getElementById('endEntry').textContent = endEntry;
        document.getElementById('totalEntries').textContent = totalEntries;
        
        currentPage = page;
    }
    
    function updatePagination() {
        const pagination = document.getElementById('pagination');
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        
        pagination.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = '<a class="page-link" href="#" data-page="prev">Previous</a>';
        pagination.appendChild(prevLi);
        
        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = '<a class="page-link" href="#" data-page="1">1</a>';
            pagination.appendChild(firstLi);
            
            if (startPage > 2) {
                const dotsLi = document.createElement('li');
                dotsLi.className = 'page-item disabled';
                dotsLi.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(dotsLi);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const dotsLi = document.createElement('li');
                dotsLi.className = 'page-item disabled';
                dotsLi.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(dotsLi);
            }
            
            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
            pagination.appendChild(lastLi);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = '<a class="page-link" href="#" data-page="next">Next</a>';
        pagination.appendChild(nextLi);
        
        // Add click events
        pagination.addEventListener('click', function(e) {
            e.preventDefault();
            if (e.target.tagName === 'A') {
                const page = e.target.dataset.page;
                if (page === 'prev' && currentPage > 1) {
                    displayPage(currentPage - 1);
                    updatePagination();
                } else if (page === 'next' && currentPage < totalPages) {
                    displayPage(currentPage + 1);
                    updatePagination();
                } else if (!isNaN(page)) {
                    displayPage(parseInt(page));
                    updatePagination();
                }
            }
        });
    }
    
    // Initialize table if it exists
    if (document.getElementById('budgetTable')) {
        initializeTable();
    }
    
    // Handle warning and confirmation
    {% if show_warning %}
    // Disable the submit button by default when warning is shown
    document.getElementById('submitBtn').disabled = true;
    {% endif %}
});

// Functions for handling the confirmation dialog
function confirmOverwrite() {
    document.getElementById('confirm_overwrite').value = 'yes';
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('budgetForm').submit();
}

function cancelOverwrite() {
    // Clear the form or redirect to budget page
    window.location.href = '/budget';
}
</script>
{% endblock %}
